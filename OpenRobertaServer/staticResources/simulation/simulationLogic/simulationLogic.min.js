function Robot(a){this.pose=a;var b={x:a.x,y:a.y,theta:a.theta,transX:a.transX,transY:a.transY};this.reset=function(){this.pose.x=b.x,this.pose.y=b.y,this.pose.theta=b.theta,this.pose.xOld=b.x,this.pose.yOld=b.y,this.pose.thetaOld=b.theta,this.pose.transX=b.transX,this.pose.transY=b.transY,this.encoder.left=0,this.encoder.right=0,this.led.color="#dddddd",this.led.mode=OFF,this.time=0}}function SimpleRobot(){Robot.call(this,{x:240,y:200,theta:0,xOld:240,yOld:200,transX:0,transY:0})}function RobertaRobot(){Robot.call(this,{x:70,y:90,theta:0,xOld:70,yOld:90,transX:0,transY:0})}function RescueRobot(){Robot.call(this,{x:400,y:40,theta:0,xOld:400,yOld:40,transX:0,transY:0})}function DrawRobot(){Robot.call(this,{x:200,y:200,theta:0,xOld:200,yOld:200,transX:0,transY:0}),this.canDraw=!0,this.drawColor="#000000",this.drawWidth=10}function MathRobot(){Robot.call(this,{x:400,y:250,theta:0,xOld:400,yOld:250,transX:-400,transY:-250}),this.canDraw=!0,this.drawColor="#ffffff",this.drawWidth=1}function Scene(a,b,c,d){this.backgroundImg=a,this.robot=c,this.obstacle=d,this.uCtx=b[0],this.bCtx=b[1],this.oCtx=b[2],this.rCtx=b[3],this.playground={x:0,y:0,w:0,h:0},this.wave=0}Robot.prototype.geom={x:-20,y:-20,w:40,h:50,color:"#FCCC00"},Robot.prototype.wheelLeft={x:16,y:-8,w:8,h:16,color:"#000000"},Robot.prototype.wheelRight={x:-24,y:-8,w:8,h:16,color:"#000000"},Robot.prototype.wheelBack={x:-2.5,y:30,w:5,h:5,color:"#000000"},Robot.prototype.led={x:0,y:10,color:"#dddddd",mode:""},Robot.prototype.encoder={left:0,right:0},Robot.prototype.colorSensor={x:0,y:-15,rx:0,ry:0,r:5,colorValue:0,color:"grey"},Robot.prototype.lightSensor={x:0,y:-15,rx:0,ry:0,r:5,lightValue:0},Robot.prototype.ultraSensor={x:0,y:-20,rx:0,ry:0,distance:0,u:[],cx:0,cy:0,color:"#FF69B4"},Robot.prototype.touchSensor={x:0,y:-25,x1:0,y1:0,x2:0,y2:0,value:0,color:"#FFCC33"},Robot.prototype.frontLeft={x:22.5,y:-25,rx:0,ry:0,bumped:!1},Robot.prototype.frontRight={x:-22.5,y:-25,rx:0,ry:0,bumped:!1},Robot.prototype.backLeft={x:20,y:30,rx:0,ry:0,bumped:!1},Robot.prototype.backRight={x:-20,y:30,rx:0,ry:0,bumped:!1},Robot.prototype.backMiddle={x:0,y:30,rx:0,ry:0},Robot.prototype.mouse={x:0,y:5,rx:0,ry:0,r:30},Robot.prototype.time=0,Robot.prototype.updatePose=function(a){if(this.pose.theta=(this.pose.theta+2*Math.PI)%(2*Math.PI),this.encoder.left+=a.left*SIM.getDt(),this.encoder.right+=a.right*SIM.getDt(),this.bumpedAready=!1,this.frontLeft.bumped&&a.left>0&&(a.left*=-1,this.bumpedAready=!0),this.backLeft.bumped&&a.left<0&&(a.left*=-1,this.bumpedAready=!0),this.frontRight.bumped&&a.right>0&&(a.right*=-1,this.bumpedAready=!0),this.backRight.bumped&&a.right<0&&(a.right*=-1,this.bumpedAready=!0),a.right==a.left){var b=a.right*SIM.getDt(),c=Math.cos(this.pose.theta)*b,d=Math.sqrt(Math.pow(b,2)-Math.pow(c,2));this.pose.x+=c,b>=0?this.pose.theta<Math.PI?this.pose.y+=d:this.pose.y-=d:this.pose.theta>Math.PI?this.pose.y+=d:this.pose.y-=d}else{var e=TRACKWIDTH/2*((a.left+a.right)/(a.left-a.right)),f=(a.left-a.right)/TRACKWIDTH,g=this.pose.x-e*Math.sin(this.pose.theta),h=this.pose.y+e*Math.cos(this.pose.theta);this.pose.x=Math.cos(f*SIM.getDt())*(this.pose.x-g)-Math.sin(f*SIM.getDt())*(this.pose.y-h)+g,this.pose.y=Math.sin(f*SIM.getDt())*(this.pose.x-g)+Math.cos(f*SIM.getDt())*(this.pose.y-h)+h;this.pose.theta;this.pose.theta=this.pose.theta+f*SIM.getDt()}var j=Math.sin(this.pose.theta),k=Math.cos(this.pose.theta);this.frontRight=this.translate(j,k,this.frontRight),this.frontLeft=this.translate(j,k,this.frontLeft),this.backRight=this.translate(j,k,this.backRight),this.backLeft=this.translate(j,k,this.backLeft),this.backMiddle=this.translate(j,k,this.backMiddle),this.touchSensor=this.translate(j,k,this.touchSensor),this.colorSensor=this.translate(j,k,this.colorSensor),this.ultraSensor=this.translate(j,k,this.ultraSensor),this.mouse=this.translate(j,k,this.mouse),this.touchSensor.x1=this.frontRight.rx,this.touchSensor.y1=this.frontRight.ry,this.touchSensor.x2=this.frontLeft.rx,this.touchSensor.y2=this.frontLeft.ry},Robot.prototype.translate=function(a,b,c){return c.rx=this.pose.x-c.y*b+c.x*a,c.ry=this.pose.y-c.y*a-c.x*b,c},SimpleRobot.prototype=Object.create(Robot.prototype),SimpleRobot.prototype.constructor=SimpleRobot,RobertaRobot.prototype=Object.create(Robot.prototype),RobertaRobot.prototype.constructor=RobertaRobot,RescueRobot.prototype=Object.create(Robot.prototype),RescueRobot.prototype.constructor=RescueRobot,DrawRobot.prototype=Object.create(Robot.prototype),DrawRobot.prototype.constructor=DrawRobot,DrawRobot.prototype.geom={x:-20,y:-20,w:40,h:40,color:"#FF69B4"},DrawRobot.prototype.touchSensor={x:0,y:-25,x1:0,y1:0,x2:0,y2:0,value:0,color:"#FF69B4"},DrawRobot.prototype.wheelBack={x:-2.5,y:20,w:5,h:5,color:"#999999"},DrawRobot.prototype.led={x:0,y:0,color:"#000000",mode:""},DrawRobot.prototype.frontLeft={x:22.5,y:-25,rx:0,ry:0,bumped:!1},DrawRobot.prototype.frontRight={x:-22.5,y:-25,rx:0,ry:0,bumped:!1},DrawRobot.prototype.backLeft={x:20,y:20,rx:0,ry:0,bumped:!1},DrawRobot.prototype.backRight={x:-20,y:20,rx:0,ry:0,bumped:!1},DrawRobot.prototype.backMiddle={x:0,y:20,rx:0,ry:0},MathRobot.prototype=Object.create(Robot.prototype),MathRobot.prototype.constructor=MathRobot,Scene.prototype.updateBackgrounds=function(){this.drawBackground(1,this.uCtx),this.drawBackground()},Scene.prototype.drawBackground=function(a,b){var c=b||this.bCtx,d=a||SIM.getScale();c.restore(),c.clearRect(0,0,MAX_WIDTH,MAX_HEIGHT),c.save(),c.scale(d,d),this.backgroundImg&&c.drawImage(this.backgroundImg,0,0)},Scene.prototype.drawObjects=function(){this.oCtx.clearRect(this.obstacle.xOld-20,this.obstacle.yOld-20,this.obstacle.wOld+40,this.obstacle.hOld+40),this.obstacle.xOld=this.obstacle.x,this.obstacle.yOld=this.obstacle.y,this.obstacle.wOld=this.obstacle.w,this.obstacle.hOld=this.obstacle.h,this.oCtx.restore(),this.oCtx.save(),this.oCtx.scale(SIM.getScale(),SIM.getScale()),this.obstacle.img?this.oCtx.drawImage(this.obstacle.img,this.obstacle.x,this.obstacle.y,this.obstacle.w,this.obstacle.h):this.obstacle.color&&(this.oCtx.fillStyle=this.obstacle.color,this.oCtx.shadowBlur=5,this.oCtx.shadowColor="black",this.oCtx.fillRect(this.obstacle.x,this.obstacle.y,this.obstacle.w,this.obstacle.h))},Scene.prototype.drawRobot=function(){if(this.rCtx.clearRect(0,0,MAX_WIDTH,MAX_HEIGHT),this.rCtx.restore(),this.rCtx.save(),SIM.getInfo()){var a=this.playground.w-40,b=this.playground.w-5,c=20;this.rCtx.fillStyle="rgba(255,255,255,0.5)",this.rCtx.fillRect(a-80,0,this.playground.w,200),this.rCtx.textAlign="end",this.rCtx.font="10px Verdana";var d,e;5===SIM.getBackground()?(d=(this.robot.pose.x+this.robot.pose.transX)/3,e=(-this.robot.pose.y-this.robot.pose.transY)/3,this.rCtx.fillStyle="#ffffff"):(d=this.robot.pose.x+this.robot.pose.transX,e=+this.robot.pose.y+this.robot.pose.transY,this.rCtx.fillStyle="#333333"),this.rCtx.fillText("FPS",a,c),this.rCtx.fillText(Math.round(1/SIM.getDt()),b,c),c+=15,this.rCtx.fillText("Time",a,c),this.rCtx.fillText(Math.round(10*this.robot.time)/10,b,c),c+=15,this.rCtx.fillText("Robot X",a,c),this.rCtx.fillText(Math.round(d),b,c),c+=15,this.rCtx.fillText("Robot Y",a,c),this.rCtx.fillText(Math.round(e),b,c),c+=15,this.rCtx.fillText("Robot \u03b8",a,c),this.rCtx.fillText(Math.round(Math.round(SIMATH.toDegree(this.robot.pose.theta))),b,c),c+=25,this.rCtx.fillText("Motor left",a,c),this.rCtx.fillText(Math.round(this.robot.encoder.left*ENC),b,c),c+=15,this.rCtx.fillText("Motor right",a,c),this.rCtx.fillText(Math.round(this.robot.encoder.right*ENC),b,c),c+=15,this.rCtx.fillText("Touch Sensor",a,c),this.rCtx.fillText(Math.round(this.robot.touchSensor.value),b,c),c+=15,this.rCtx.fillText("Light Sensor",a,c),this.rCtx.fillText(Math.round(Math.round(this.robot.lightSensor.lightValue)),b,c),c+=15,this.rCtx.fillText("Ultra Sensor",a,c),this.rCtx.fillText(Math.round(this.robot.ultraSensor.distance/3),b,c),c+=15,this.rCtx.fillText("Color Sensor",a,c),this.rCtx.beginPath(),this.rCtx.fillStyle=this.robot.colorSensor.color,this.rCtx.rect(b,c,-10,-10),this.rCtx.stroke(),this.rCtx.fill()}this.rCtx.scale(SIM.getScale(),SIM.getScale()),this.rCtx.save(),this.rCtx.translate(this.robot.pose.x,this.robot.pose.y),this.rCtx.rotate(SIMATH.toRadians(SIMATH.toDegree(this.robot.pose.theta)-90)),this.rCtx.scale(1,-1),this.rCtx.lineWidth="2.5",this.rCtx.strokeStyle=this.robot.wheelLeft.color,this.rCtx.beginPath(),this.rCtx.moveTo(this.robot.geom.x-5,0),this.rCtx.lineTo(this.robot.geom.x+this.robot.geom.w+5,0),this.rCtx.stroke(),this.rCtx.fillStyle=this.robot.wheelBack.color,this.rCtx.fillRect(this.robot.wheelBack.x,this.robot.wheelBack.y,this.robot.wheelBack.w,this.robot.wheelBack.h),this.rCtx.shadowBlur=0,this.rCtx.shadowOffsetX=0,this.rCtx.fillStyle=this.robot.touchSensor.color,this.rCtx.fillRect(this.robot.frontRight.x+12.5,this.robot.frontRight.y,20,10),this.rCtx.fillStyle=this.robot.led.color;var f=this.rCtx.createRadialGradient(this.robot.led.x,this.robot.led.y,1,this.robot.led.x,this.robot.led.y,15);f.addColorStop(0,this.robot.led.color),f.addColorStop(.5,this.robot.geom.color),this.rCtx.shadowBlur=5,this.rCtx.shadowColor="black",this.rCtx.fillStyle=f,this.rCtx.beginPath(),this.rCtx.moveTo(this.robot.geom.x+2.5,this.robot.geom.y),this.rCtx.lineTo(this.robot.geom.x+this.robot.geom.w-2.5,this.robot.geom.y),this.rCtx.quadraticCurveTo(this.robot.geom.x+this.robot.geom.w,this.robot.geom.y,this.robot.geom.x+this.robot.geom.w,this.robot.geom.y+2.5),this.rCtx.lineTo(this.robot.geom.x+this.robot.geom.w,this.robot.geom.y+this.robot.geom.h-2.5),this.rCtx.quadraticCurveTo(this.robot.geom.x+this.robot.geom.w,this.robot.geom.y+this.robot.geom.h,this.robot.geom.x+this.robot.geom.w-2.5,this.robot.geom.y+this.robot.geom.h),this.rCtx.lineTo(this.robot.geom.x+2.5,this.robot.geom.y+this.robot.geom.h),this.rCtx.quadraticCurveTo(this.robot.geom.x,this.robot.geom.y+this.robot.geom.h,this.robot.geom.x,this.robot.geom.y+this.robot.geom.h-2.5),this.rCtx.lineTo(this.robot.geom.x,this.robot.geom.y+2.5),this.rCtx.quadraticCurveTo(this.robot.geom.x,this.robot.geom.y,this.robot.geom.x+2.5,this.robot.geom.y),this.rCtx.closePath(),this.rCtx.fill(),this.rCtx.shadowBlur=5,this.rCtx.shadowOffsetX=2,1===this.robot.touchSensor.value?(this.rCtx.fillStyle="red",this.rCtx.fillRect(this.robot.frontRight.x,this.robot.frontRight.y,this.robot.frontLeft.x-this.robot.frontRight.x,3.5)):(this.rCtx.fillStyle=this.robot.touchSensor.color,this.rCtx.fillRect(this.robot.frontRight.x,this.robot.frontRight.y,this.robot.frontLeft.x-this.robot.frontRight.x,3.5)),this.rCtx.shadowBlur=0,this.rCtx.shadowOffsetX=0,this.rCtx.fillStyle=this.robot.led.color,this.rCtx.beginPath(),this.rCtx.arc(this.robot.led.x,this.robot.led.y,2.5,0,2*Math.PI),this.rCtx.fill(),this.rCtx.fillStyle=this.robot.wheelLeft.color,this.rCtx.fillRect(this.robot.wheelLeft.x,this.robot.wheelLeft.y,this.robot.wheelLeft.w,this.robot.wheelLeft.h),this.rCtx.fillStyle=this.robot.wheelRight.color,this.rCtx.fillRect(this.robot.wheelRight.x,this.robot.wheelRight.y,this.robot.wheelRight.w,this.robot.wheelRight.h),this.rCtx.lineWidth="0.5",this.rCtx.beginPath(),this.rCtx.arc(0,-15,this.robot.colorSensor.r,0,2*Math.PI),this.rCtx.fillStyle=this.robot.colorSensor.color,this.rCtx.fill(),this.rCtx.strokeStyle="black",this.rCtx.stroke(),this.rCtx.restore(),this.wave+=WAVE_LENGTH*SIM.getDt(),this.wave=this.wave%WAVE_LENGTH,this.rCtx.lineDashOffset=WAVE_LENGTH-this.wave,this.rCtx.setLineDash([20,40]),this.rCtx.beginPath(),this.rCtx.lineWidth="0.5",this.rCtx.strokeStyle="#555555";for(var g=0;g<this.robot.ultraSensor.u.length;g++)this.rCtx.moveTo(this.robot.ultraSensor.rx,this.robot.ultraSensor.ry),this.rCtx.lineTo(this.robot.ultraSensor.u[g].x,this.robot.ultraSensor.u[g].y);this.rCtx.stroke(),this.rCtx.beginPath(),this.rCtx.strokeStyle="black",this.rCtx.moveTo(this.robot.ultraSensor.rx,this.robot.ultraSensor.ry),this.rCtx.lineTo(this.robot.ultraSensor.cx,this.robot.ultraSensor.cy),this.rCtx.stroke(),this.rCtx.lineDashOffset=0,this.rCtx.setLineDash([]),this.robot.canDraw&&(this.bCtx.lineCap="round",this.bCtx.beginPath(),this.bCtx.lineWidth=this.robot.drawWidth,this.bCtx.strokeStyle=this.robot.drawColor,this.bCtx.moveTo(this.robot.pose.xOld,this.robot.pose.yOld),this.bCtx.lineTo(this.robot.pose.x,this.robot.pose.y),this.bCtx.stroke(),this.uCtx.beginPath(),this.uCtx.lineCap="round",this.uCtx.lineWidth=this.robot.drawWidth,this.uCtx.strokeStyle=this.robot.drawColor,this.uCtx.moveTo(this.robot.pose.xOld,this.robot.pose.yOld),this.uCtx.lineTo(this.robot.pose.x,this.robot.pose.y),this.uCtx.stroke(),this.robot.pose.xOld=this.robot.pose.x,this.robot.pose.yOld=this.robot.pose.y)},Scene.prototype.updateSensorValues=function(a){var b={};if(this.robot.touchSensor){this.robot.touchSensor.value=0,this.robot.frontLeft.bumped=!1,this.robot.frontRight.bumped=!1,this.robot.backLeft.bumped=!1,this.robot.backRight.bumped=!1;for(var c=0;c<SIM.obstacleList.length;c++)for(var d=SIMATH.getLinesFromRect(SIM.obstacleList[c]),e=0;e<d.length;e++){var f=SIMATH.getIntersectionPoint({x1:this.robot.frontLeft.rx,x2:this.robot.frontRight.rx,y1:this.robot.frontLeft.ry,y2:this.robot.frontRight.ry},d[e]);if(f)Math.abs(this.robot.frontLeft.rx-f.x)<Math.abs(this.robot.frontRight.rx-f.x)?this.robot.frontLeft.bumped=!0:this.robot.frontRight.bumped=!0,this.robot.touchSensor.value=1;else{var g=SIMATH.getDistanceToLine({x:this.robot.touchSensor.rx,y:this.robot.touchSensor.ry},{x:d[e].x1,y:d[e].y1},{x:d[e].x2,y:d[e].y2});if(SIMATH.sqr(this.robot.touchSensor.rx-g.x)+SIMATH.sqr(this.robot.touchSensor.ry-g.y)<SIM.getDt()*Math.max(Math.abs(SIM.output.right),Math.abs(SIM.output.left)))this.robot.frontLeft.bumped=!0,this.robot.frontRight.bumped=!0,this.robot.touchSensor.value=1;else{var f=SIMATH.getIntersectionPoint({x1:this.robot.backLeft.rx,x2:this.robot.backRight.rx,y1:this.robot.backLeft.ry,y2:this.robot.backRight.ry},d[e]);if(f)Math.abs(this.robot.backLeft.rx-f.x)<Math.abs(this.robot.backRight.rx-f.x)?this.robot.backLeft.bumped=!0:this.robot.backRight.bumped=!0;else{var g=SIMATH.getDistanceToLine({x:this.robot.touchSensor.rx,y:this.robot.touchSensor.ry},{x:d[e].x1,y:d[e].y1},{x:d[e].x2,y:d[e].y2});SIMATH.sqr(this.robot.backMiddle.rx-g.x)+SIMATH.sqr(this.robot.backMiddle.ry-g.y)<SIM.getDt()*Math.max(Math.abs(SIM.output.right),Math.abs(SIM.output.left))&&(this.robot.backLeft.bumped=!0,this.robot.backRight.bumped=!0)}}}}1===this.robot.touchSensor.value||this.robot.bumpedAready?(this.robot.touchSensor.value=1,b.touch=!0):b.touch=!1}if(this.robot.colorSensor||this.robot.lightSensor){for(var h=0,i=0,j=0,k=this.uCtx.getImageData(Math.round(this.robot.colorSensor.rx-3),Math.round(this.robot.colorSensor.ry-3),6,6),l=[0,4,16,20,24,44,92,116,120,124,136,140],j=0,m=0;m<k.data.length;m+=24)for(var c=m;m+24>c;c+=4)l.indexOf(c)<0&&(h+=k.data[c+0],i+=k.data[c+1],j+=k.data[c+2],j++);var n=k.data.length/4-12,o=h/n,p=i/n,q=j/n;this.robot.colorSensor&&(this.robot.colorSensor.colorValue=SIMATH.getColor(SIMATH.rgbToHsv(o,p,q)),b.color=this.robot.colorSensor.colorValue,this.robot.colorSensor.colorValue===COLOR_ENUM.NONE?this.robot.colorSensor.color="grey":this.robot.colorSensor.colorValue===COLOR_ENUM.BLACK?this.robot.colorSensor.color="black":this.robot.colorSensor.colorValue==COLOR_ENUM.WHITE?this.robot.colorSensor.color="white":this.robot.colorSensor.colorValue===COLOR_ENUM.YELLOW?this.robot.colorSensor.color="yellow":this.robot.colorSensor.colorValue===COLOR_ENUM.BROWN?this.robot.colorSensor.color="brown":this.robot.colorSensor.colorValue===COLOR_ENUM.RED?this.robot.colorSensor.color="red":this.robot.colorSensor.colorValue===COLOR_ENUM.BLUE?this.robot.colorSensor.color="blue":this.robot.colorSensor.colorValue===COLOR_ENUM.GREEN&&(this.robot.colorSensor.color="lime")),this.robot.lightSensor&&(this.robot.lightSensor.lightValue=(o+p+q)/3/2.55,b.light=this.robot.lightSensor.lightValue)}if(this.robot.ultraSensor){var r={x1:this.robot.ultraSensor.rx,y1:this.robot.ultraSensor.ry,x2:this.robot.ultraSensor.rx+MAXDIAG*Math.cos(this.robot.pose.theta),y2:this.robot.ultraSensor.ry+MAXDIAG*Math.sin(this.robot.pose.theta)},s={x1:this.robot.ultraSensor.rx,y1:this.robot.ultraSensor.ry,x2:this.robot.ultraSensor.rx+MAXDIAG*Math.cos(this.robot.pose.theta-Math.PI/8),y2:this.robot.ultraSensor.ry+MAXDIAG*Math.sin(this.robot.pose.theta-Math.PI/8)},t={x1:this.robot.ultraSensor.rx,y1:this.robot.ultraSensor.ry,x2:this.robot.ultraSensor.rx+MAXDIAG*Math.cos(this.robot.pose.theta-Math.PI/16),y2:this.robot.ultraSensor.ry+MAXDIAG*Math.sin(this.robot.pose.theta-Math.PI/16)},u={x1:this.robot.ultraSensor.rx,y1:this.robot.ultraSensor.ry,x2:this.robot.ultraSensor.rx+MAXDIAG*Math.cos(this.robot.pose.theta+Math.PI/8),y2:this.robot.ultraSensor.ry+MAXDIAG*Math.sin(this.robot.pose.theta+Math.PI/8)},v={x1:this.robot.ultraSensor.rx,y1:this.robot.ultraSensor.ry,x2:this.robot.ultraSensor.rx+MAXDIAG*Math.cos(this.robot.pose.theta+Math.PI/16),y2:this.robot.ultraSensor.ry+MAXDIAG*Math.sin(this.robot.pose.theta+Math.PI/16)},w=new Array(s,t,r,v,u);this.robot.ultraSensor.distance=MAXDIAG;for(var c=0;c<SIM.obstacleList.length;c++)for(var d=SIMATH.getLinesFromRect(SIM.obstacleList[c]),x=[MAXDIAG,MAXDIAG,MAXDIAG,MAXDIAG,MAXDIAG],e=0;e<d.length;e++)for(var m=0;m<w.length;m++){var f=SIMATH.getIntersectionPoint(w[m],d[e]);if(f){var y=Math.sqrt((f.x-this.robot.ultraSensor.rx)*(f.x-this.robot.ultraSensor.rx)+(f.y-this.robot.ultraSensor.ry)*(f.y-this.robot.ultraSensor.ry));y<this.robot.ultraSensor.distance&&(this.robot.ultraSensor.distance=y,this.robot.ultraSensor.cx=f.x,this.robot.ultraSensor.cy=f.y),y<x[m]&&(this.robot.ultraSensor.u[m]=f,x[m]=y)}}b.ultrasonic=this.robot.ultraSensor.distance/3}if(a&&(this.robot.time+=SIM.getDt()),b.time=this.robot.time,this.robot.encoder){var z=[];z[0]=this.robot.encoder.left*ENC,z[1]=this.robot.encoder.right*ENC,b.tacho=z}return b};var SIMATH={};!function(a){SIMATH.toRadians=function(a){return a*(Math.PI/180)},SIMATH.toDegree=function(a){return a*(180/Math.PI)},SIMATH.getIntersectionPoint=function(a,b){var c=(a.x1-a.x2)*(b.y1-b.y2)-(a.y1-a.y2)*(b.x1-b.x2);if(0===c)return null;var d=((b.x1-b.x2)*(a.x1*a.y2-a.y1*a.x2)-(a.x1-a.x2)*(b.x1*b.y2-b.y1*b.x2))/c,e=((b.y1-b.y2)*(a.x1*a.y2-a.y1*a.x2)-(a.y1-a.y2)*(b.x1*b.y2-b.y1*b.x2))/c;return d<Math.min(a.x1,a.x2)-.01||d>Math.max(a.x1,a.x2)+.01?null:d<Math.min(b.x1,b.x2)-.01||d>Math.max(b.x1,b.x2)+.01?null:e<Math.min(a.y1,a.y2)-.01||e>Math.max(a.y1,a.y2)+.01?null:e<Math.min(b.y1,b.y2)-.01||e>Math.max(b.y1,b.y2)+.01?null:{x:d,y:e}},SIMATH.getLinesFromRect=function(a){return[{x1:a.x,x2:a.x,y1:a.y,y2:a.y+a.h},{x1:a.x,x2:a.x+a.w,y1:a.y,y2:a.y},{x1:a.x+a.w,x2:a.x,y1:a.y+a.h,y2:a.y+a.h},{x1:a.x+a.w,x2:a.x+a.w,y1:a.y+a.h,y2:a.y}]},SIMATH.sqr=function(a){return a*a},SIMATH.getDistance=function(a,b){return SIMATH.sqr(a.x-b.x)+SIMATH.sqr(a.y-b.y)},SIMATH.getDistanceToLine=function(a,b,c){var d=SIMATH.getDistance(b,c);if(0==d)return b;var e=((a.x-b.x)*(c.x-b.x)+(a.y-b.y)*(c.y-b.y))/d;return 0>e?b:e>1?c:{x:b.x+e*(c.x-b.x),y:b.y+e*(c.y-b.y)}},SIMATH.rgbToHsv=function(a,b,c){var g,h,d=Math.min(a,b,c),e=Math.max(a,b,c),f=e-d,i=e;return i=Math.floor(e/255*100),0===e?[0,0,0]:(h=Math.floor(f/e*100),g=a===e?(b-c)/f:b===e?2+(c-a)/f:4+(a-b)/f,g=Math.floor(60*g),0>g&&(g+=360),[g,h,i])},SIMATH.getColor=function(a){return a[2]<=10?COLOR_ENUM.BLACK:(a[0]<10||a[0]>350)&&a[1]>90&&a[2]>50?COLOR_ENUM.RED:a[0]>40&&a[0]<70&&a[1]>90&&a[2]>50?COLOR_ENUM.YELLOW:a[0]<50&&a[1]>50&&a[1]<100&&a[2]<50?COLOR_ENUM.BROWN:a[1]<10&&a[2]>90?COLOR_ENUM.WHITE:a[0]>70&&a[0]<160&&a[1]>80?COLOR_ENUM.GREEN:a[0]>200&&a[0]<250&&a[1]>90&&a[2]>50?COLOR_ENUM.BLUE:COLOR_ENUM.NONE}}($);var SIM=function(){function setBackground(a){return window.removeEventListener("resize",resizeAll),setPause(!0),0===a?(currentBackground+=1,currentBackground>5&&(currentBackground=1)):currentBackground=a,1==currentBackground?robot=new SimpleRobot:2==currentBackground?robot=new DrawRobot:3==currentBackground?robot=new RobertaRobot:4==currentBackground?robot=new RescueRobot:5==currentBackground&&(robot=new MathRobot),setObstacle(),scene=new Scene(img[currentBackground],layers,robot,obstacle),resizeAll(),scene.updateBackgrounds(),scene.drawObjects(),reloadProgram(),window.addEventListener("resize",resizeAll),currentBackground}function getBackground(){return currentBackground}function getDt(){return dt}function setPause(a){a||ready?(a?($(".simForward").removeClass("typcn-media-pause"),$(".simForward").addClass("typcn-media-play")):($(".simForward").removeClass("typcn-media-play"),$(".simForward").addClass("typcn-media-pause")),pause=a):setTimeout(function(){setPause(!1)},100)}function setStep(){stepCounter=-50,setPause(!1)}function setInfo(){info=info===!0?!1:!0}function stopProgram(){setPause(!0),robot.reset(),scene.updateBackgrounds(),reloadProgram()}function init(program){ready=!1,userProgram=program,eval(userProgram),canceled=!1,isDownrobot=!1,isDownObstacle=!1,stepCounter=0,pause=!0,info=!1,robot.reset(),img=[],loadImages(0)}function cancel(){$(window).off("resize"),canceled=!0,removeMouseEvents(),destroyLayers()}function render(){if(canceled)return void cancelAnimationFrame(globalID);globalID=requestAnimationFrame(render);var now=(new Date).getTime();dt=now-(time||now),dt/=1e3,time=now,stepCounter+=1,output.left=0,output.right=0,PROGRAM_SIMULATION.isTerminated()||pause?PROGRAM_SIMULATION.isTerminated()&&(reloadProgram(),eval(userProgram),$(".simForward").removeClass("typcn-media-pause"),$(".simForward").addClass("typcn-media-play"),setPause(!0)):(0===stepCounter&&setPause(!0),step(input),setOutput()),robot.updatePose(output),input=scene.updateSensorValues(!pause),scene.drawRobot()}function reloadProgram(){eval(userProgram),$(".simForward").removeClass("typcn-media-pause"),$(".simForward").addClass("typcn-media-play")}function setOutput(){output.left=ACTORS.getLeftMotor().getPower()*MAXPOWER||0,output.right=ACTORS.getRightMotor().getPower()*MAXPOWER||0,robot.led.mode=output.ledMode=LIGHT.getMode()||"OFF",LIGHT.getMode()&&"OFF"==LIGHT.getMode()?robot.led.color=output.led="#dddddd":robot.led.color=output.led=LIGHT.getColor()}function setObstacle(){2==currentBackground?(obstacle.x=500,obstacle.y=250,obstacle.w=100,obstacle.h=100,obstacle.img=null,obstacle.color="#33B8CA"):1==currentBackground?(obstacle.x=580,obstacle.y=290,obstacle.w=100,obstacle.h=100,obstacle.img=null,obstacle.color="#33B8CA"):3==currentBackground?(obstacle.x=500,obstacle.y=250,obstacle.w=100,obstacle.h=100,obstacle.img=img[0],obstacle.color=null):5==currentBackground?(obstacle.x=0,obstacle.y=0,obstacle.w=0,obstacle.h=0,obstacle.color=null):(obstacle.x=495,obstacle.y=396,obstacle.w=20,obstacle.h=20,obstacle.color="#33B8CA",obstacle.img=null)}function handleMouseDown(a){a.preventDefault();var b=a.clientX||a.originalEvent.touches[0].pageX,c=a.clientY||a.originalEvent.touches[0].pageY;startX=parseInt(b-offsetX,10)/scale,startY=parseInt(c-offsetY,10)/scale;var d=startX-robot.mouse.rx,e=startY-robot.mouse.ry;isDownrobot=d*d+e*e<robot.mouse.r*robot.mouse.r,isDownObstacle=startX>obstacle.x&&startX<obstacle.x+obstacle.w&&startY>obstacle.y&&startY<obstacle.y+obstacle.h}function handleMouseUp(a){a.preventDefault(),isDownrobot||isDownObstacle||(startX<ground.w/2?robot.pose.theta+=SIMATH.toRadians(-5):robot.pose.theta+=SIMATH.toRadians(5)),$("#robotLayer").css("cursor","auto"),robot instanceof DrawRobot&&(robot.canDraw=!0),isDownrobot=!1,isDownObstacle=!1}function handleMouseOut(a){a.preventDefault(),isDownrobot=!1,isDownObstacle=!1}function handleMouseMove(a){if(a.preventDefault(),isDownrobot||isDownObstacle){$("#robotLayer").css("cursor","pointer");var b=a.clientX||a.originalEvent.touches[0].pageX,c=a.clientY||a.originalEvent.touches[0].pageY;mouseX=parseInt(b-offsetX,10)/scale,mouseY=parseInt(c-offsetY,10)/scale;var d=mouseX-startX,e=mouseY-startY;startX=mouseX,startY=mouseY,isDownrobot?(robot instanceof DrawRobot&&(robot.canDraw=!1),robot.pose.xOld=robot.pose.x,robot.pose.yOld=robot.pose.y,robot.pose.x+=d,robot.pose.y+=e,robot.mouse.rx+=d,robot.mouse.ry+=e):(obstacle.x+=d,obstacle.y+=e,scene.drawObjects())}}function resizeAll(){if(!canceled){canvasOffset=$("#backgroundDiv").offset(),offsetX=canvasOffset.left,offsetY=canvasOffset.top,scene.playground.w=$("#simDiv").width(),scene.playground.h=$(window).height()-offsetY;var a=scale;scale=1,$(window).width()<768?scale=.5:$(window).width()<1024?scale=.7:$(window).width()<1280?scale=.8:$(window).width()>=1920&&(scale=1.5),ground.w=scene.playground.w/scale,ground.h=scene.playground.h/scale,a!=scale&&(scene.updateBackgrounds(),scene.drawObjects())}}function loadImages(a){a<imgSrc.length-1?(img[a]=new Image,img[a].onload=function(){loadImages(a+1)},img[a].src=imgSrc[a]):(img[a]=new Image,img[a].onload=initScene,img[a].src=imgSrc[a])}function addMouseEvents(){$("#robotLayer").mousedown(function(a){handleMouseDown(a)}),$("#robotLayer").mousemove(function(a){handleMouseMove(a)}),$("#robotLayer").mouseup(function(a){handleMouseUp(a)}),$("#robotLayer").mouseout(function(a){handleMouseOut(a)}),$("#robotLayer").bind("touchmove",function(a){handleMouseMove(a)}),$("#robotLayer").bind("touchleave",function(a){handleMouseOut(a)}),$("#robotLayer").bind("touchstart",function(a){handleMouseDown(a)}),$("#robotLayer").bind("touchend",function(a){handleMouseUp(a)})}function removeMouseEvents(){$("#robotLayer").off("mousedown"),$("#robotLayer").off("mousemove"),$("#robotLayer").off("mouseup"),$("#robotLayer").off("mouseout"),$("#robotLayer").unbind()}function initScene(){layers=createLayers(),scene=new Scene(img[currentBackground],layers,robot,obstacle),setObstacle(),scene.updateBackgrounds(),scene.drawObjects(),scene.drawRobot(),addMouseEvents(),ready=!0,$(window).on("resize",resizeAll),resizeAll(),render()}function createLayers(){$('<canvas id ="unitBackgroundLayer" width='+MAX_WIDTH+" height="+MAX_HEIGHT+"></canvas>").appendTo(document.getElementById("uniDiv"));var a=document.getElementById("unitBackgroundLayer");$('<canvas id ="backgroundLayer" width='+MAX_WIDTH+" height="+MAX_HEIGHT+"></canvas>").appendTo(document.getElementById("backgroundDiv"));var b=document.getElementById("backgroundLayer");$('<canvas id ="objectLayer" width='+MAX_WIDTH+" height="+MAX_HEIGHT+"></canvas>").appendTo(document.getElementById("objectDiv"));var c=document.getElementById("objectLayer");$('<canvas id ="robotLayer" width='+MAX_WIDTH+" height="+MAX_HEIGHT+"></canvas>").appendTo(document.getElementById("robotDiv"));var d=document.getElementById("robotLayer");return[a.getContext("2d"),b.getContext("2d"),c.getContext("2d"),d.getContext("2d")]}function destroyLayers(){for(var a=document.getElementById("backgroundLayer");a.firstChild;)a.removeChild(myNode.firstChild);for(a=document.getElementById("unitBackgroundLayer");a.firstChild;)a.removeChild(myNode.firstChild);for(a=document.getElementById("objectLayer");a.firstChild;)a.removeChild(myNode.firstChild);for(a=document.getElementById("robotLayer");a.firstChild;)a.removeChild(myNode.firstChild)}function getScale(){return scale}function getInfo(){return info}function getAverageTimeStep(){return averageTimeStep}var scene,userProgram,layers,canvasOffset,offsetX,offsetY,isDownrobot=!1,isDownObstacle=!1,startX,startY,scale=1,imgSrc=["simulation/simBackgrounds/baustelle-02.svg","simulation/simBackgrounds/simpleBackground.svg","simulation/simBackgrounds/drawBackground.svg","simulation/simBackgrounds/robertaBackground.svg","simulation/simBackgrounds/rescueBackground.svg","simulation/simBackgrounds/mathBackground.svg"],img,timerStep=0,ready,canceled,currentBackground=1,time,dt=0,pause,stepCounter,info,cP=1,turn=!1,back=!1,encoderTouch=0,start=!1,touch=!1,line=!1,ultra=!1,ground={x:0,y:0,w:500,h:500},obstacle={x:0,y:0,xOld:0,yOld:0,w:0,h:0,wOld:0,hOld:0},obstacleList=[ground,obstacle],input={touch:!1,color:"",light:0,ultrasonic:0,tacho:[0,0],time:0},output={left:0,right:0,led:" ",ledMode:" "},globalID,robot=new SimpleRobot;return{init:init,setPause:setPause,setStep:setStep,setInfo:setInfo,setBackground:setBackground,getBackground:getBackground,stopProgram:stopProgram,obstacleList:obstacleList,output:output,input:input,getScale:getScale,getInfo:getInfo,cancel:cancel,getAverageTimeStep:getAverageTimeStep,getDt:getDt}}();!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();